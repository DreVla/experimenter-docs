"use strict";(self.webpackChunkexperimenter_docs=self.webpackChunkexperimenter_docs||[]).push([[7467],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return d}});var a=n(7294);function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){l(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,l=function(e,t){if(null==e)return{};var n,a,l={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(l[n]=e[n]);return l}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(l[n]=e[n])}return l}var i=a.createContext({}),u=function(e){var t=a.useContext(i),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=u(e.components);return a.createElement(i.Provider,{value:t},e.children)},p="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},f=a.forwardRef((function(e,t){var n=e.components,l=e.mdxType,r=e.originalType,i=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),p=u(n),f=l,d=p["".concat(i,".").concat(f)]||p[f]||m[f]||r;return n?a.createElement(d,o(o({ref:t},c),{},{components:n})):a.createElement(d,o({ref:t},c))}));function d(e,t){var n=arguments,l=t&&t.mdxType;if("string"==typeof e||l){var r=n.length,o=new Array(r);o[0]=f;var s={};for(var i in t)hasOwnProperty.call(t,i)&&(s[i]=t[i]);s.originalType=e,s[p]="string"==typeof e?e:l,o[1]=s;for(var u=2;u<r;u++)o[u]=n[u];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}f.displayName="MDXCreateElement"},5162:function(e,t,n){n.d(t,{Z:function(){return o}});var a=n(7294),l=n(6010),r={tabItem:"tabItem_Ymn6"};function o(e){let{children:t,hidden:n,className:o}=e;return a.createElement("div",{role:"tabpanel",className:(0,l.Z)(r.tabItem,o),hidden:n},t)}},4866:function(e,t,n){n.d(t,{Z:function(){return y}});var a=n(3117),l=n(7294),r=n(6010),o=n(2466),s=n(6550),i=n(1980),u=n(7392),c=n(12);function p(e){return function(e){return l.Children.map(e,(e=>{if(!e||(0,l.isValidElement)(e)&&function(e){const{props:t}=e;return!!t&&"object"==typeof t&&"value"in t}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}(e).map((e=>{let{props:{value:t,label:n,attributes:a,default:l}}=e;return{value:t,label:n,attributes:a,default:l}}))}function m(e){const{values:t,children:n}=e;return(0,l.useMemo)((()=>{const e=t??p(n);return function(e){const t=(0,u.l)(e,((e,t)=>e.value===t.value));if(t.length>0)throw new Error(`Docusaurus error: Duplicate values "${t.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[t,n])}function f(e){let{value:t,tabValues:n}=e;return n.some((e=>e.value===t))}function d(e){let{queryString:t=!1,groupId:n}=e;const a=(0,s.k6)(),r=function(e){let{queryString:t=!1,groupId:n}=e;if("string"==typeof t)return t;if(!1===t)return null;if(!0===t&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:t,groupId:n});return[(0,i._X)(r),(0,l.useCallback)((e=>{if(!r)return;const t=new URLSearchParams(a.location.search);t.set(r,e),a.replace({...a.location,search:t.toString()})}),[r,a])]}function h(e){const{defaultValue:t,queryString:n=!1,groupId:a}=e,r=m(e),[o,s]=(0,l.useState)((()=>function(e){let{defaultValue:t,tabValues:n}=e;if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(t){if(!f({value:t,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${t}" but none of its children has the corresponding value. Available values are: ${n.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return t}const a=n.find((e=>e.default))??n[0];if(!a)throw new Error("Unexpected error: 0 tabValues");return a.value}({defaultValue:t,tabValues:r}))),[i,u]=d({queryString:n,groupId:a}),[p,h]=function(e){let{groupId:t}=e;const n=function(e){return e?`docusaurus.tab.${e}`:null}(t),[a,r]=(0,c.Nk)(n);return[a,(0,l.useCallback)((e=>{n&&r.set(e)}),[n,r])]}({groupId:a}),g=(()=>{const e=i??p;return f({value:e,tabValues:r})?e:null})();(0,l.useLayoutEffect)((()=>{g&&s(g)}),[g]);return{selectedValue:o,selectValue:(0,l.useCallback)((e=>{if(!f({value:e,tabValues:r}))throw new Error(`Can't select invalid tab value=${e}`);s(e),u(e),h(e)}),[u,h,r]),tabValues:r}}var g=n(2389),b={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};function k(e){let{className:t,block:n,selectedValue:s,selectValue:i,tabValues:u}=e;const c=[],{blockElementScrollPositionUntilNextRender:p}=(0,o.o5)(),m=e=>{const t=e.currentTarget,n=c.indexOf(t),a=u[n].value;a!==s&&(p(t),i(a))},f=e=>{let t=null;switch(e.key){case"Enter":m(e);break;case"ArrowRight":{const n=c.indexOf(e.currentTarget)+1;t=c[n]??c[0];break}case"ArrowLeft":{const n=c.indexOf(e.currentTarget)-1;t=c[n]??c[c.length-1];break}}t?.focus()};return l.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,r.Z)("tabs",{"tabs--block":n},t)},u.map((e=>{let{value:t,label:n,attributes:o}=e;return l.createElement("li",(0,a.Z)({role:"tab",tabIndex:s===t?0:-1,"aria-selected":s===t,key:t,ref:e=>c.push(e),onKeyDown:f,onClick:m},o,{className:(0,r.Z)("tabs__item",b.tabItem,o?.className,{"tabs__item--active":s===t})}),n??t)})))}function w(e){let{lazy:t,children:n,selectedValue:a}=e;const r=(Array.isArray(n)?n:[n]).filter(Boolean);if(t){const e=r.find((e=>e.props.value===a));return e?(0,l.cloneElement)(e,{className:"margin-top--md"}):null}return l.createElement("div",{className:"margin-top--md"},r.map(((e,t)=>(0,l.cloneElement)(e,{key:t,hidden:e.props.value!==a}))))}function v(e){const t=h(e);return l.createElement("div",{className:(0,r.Z)("tabs-container",b.tabList)},l.createElement(k,(0,a.Z)({},e,t)),l.createElement(w,(0,a.Z)({},e,t)))}function y(e){const t=(0,g.Z)();return l.createElement(v,(0,a.Z)({key:String(t)},e))}},1217:function(e,t,n){n.r(t),n.d(t,{assets:function(){return c},contentTitle:function(){return i},default:function(){return d},frontMatter:function(){return s},metadata:function(){return u},toc:function(){return p}});var a=n(3117),l=(n(7294),n(3905)),r=n(4866),o=n(5162);const s={id:"growable-collections",title:"Managing collections not known before release",slug:"/cookbook/fml/growable-collections"},i=void 0,u={unversionedId:"cookbook/fml/growable-collections",id:"cookbook/fml/growable-collections",title:"Managing collections not known before release",description:"Problem",source:"@site/docs/cookbook/fml/growable-collections.mdx",sourceDirName:"cookbook/fml",slug:"/cookbook/fml/growable-collections",permalink:"/cookbook/fml/growable-collections",draft:!1,editUrl:"https://github.com/mozilla/experimenter-docs/edit/main/docs/cookbook/fml/growable-collections.mdx",tags:[],version:"current",frontMatter:{id:"growable-collections",title:"Managing collections not known before release",slug:"/cookbook/fml/growable-collections"}},c={},p=[{value:"Problem",id:"problem",level:2},{value:"Solution",id:"solution",level:2},{value:"Discussion",id:"discussion",level:2},{value:"Exposure events",id:"exposure-events",level:3},{value:"Local development",id:"local-development",level:3}],m={toc:p},f="wrapper";function d(e){let{components:t,...n}=e;return(0,l.kt)(f,(0,a.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,l.kt)("h2",{id:"problem"},"Problem"),(0,l.kt)("p",null,"You want to configure a collection of things of the same type, but the configuration isn't known at build time."),(0,l.kt)("p",null,"For example,"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"a collection of messages, or"),(0,l.kt)("li",{parentName:"ul"},"a collection of wallpapers.")),(0,l.kt)("h2",{id:"solution"},"Solution"),(0,l.kt)("p",null,"Use a type of ",(0,l.kt)("inlineCode",{parentName:"p"},"Map<String, T>"),"."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"---\nchannels:\n  - debug\n  - release\nfeatures:\n  theming-feature:\n    description: Configuration for theming feature.\n    variables:\n      asset-urls:\n        description: A collection of downloadable assets\n        type: Map<String, String>\n        default: {}\n  defaults:\n    - channel: debug\n      value:\n        assets-urls:\n          kittens: https://placekitten.com/600/900\n          bill-murray: https://www.fillmurray.com/600/900\n          flickr: https://loremflickr.com/600/900\n    - channel: release\n      value:\n        assets-urls:\n          default-theme: https://www.mozilla.com/assets/wp-default/600/900\n\n")),(0,l.kt)("p",null,"The collection of URLs is available in code as:"),(0,l.kt)(r.Z,{defaultValue:"swift",values:[{label:"Swift",value:"swift"},{label:"Kotlin",value:"kotlin"}],mdxType:"Tabs"},(0,l.kt)(o.Z,{value:"swift",mdxType:"TabItem"},(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-swift"},"let themingConfig = MyNimbus.features.themingFeature.value()\nlet assetMap: [String: String] = themingConfig.assetUrls\n\n// A list of URLs\nlet urls = assetMap.values().compactMap { URL(string: $0 )}\n"))),(0,l.kt)(o.Z,{value:"kotlin",mdxType:"TabItem"},(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-kotlin"},"val themingConfig = MyNimbus.features.themingFeature.value()\nval assetMap: Map<String, String> = themingConfig.assetUrls\n\n// A list of URLs\nval url = assetMap.values().mapNotNull { URL(it) }\n")))),(0,l.kt)("h2",{id:"discussion"},"Discussion"),(0,l.kt)("p",null,"The feature manifest defines the shape i.e. the types, of the complete configuration for a feature. It also defines a default configuration which the app uses if there are no experiments running."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"      asset-urls:\n        description: A collection of downloadable assets\n        type: Map<String, String>\n        default: {}\n")),(0,l.kt)("p",null,"This might be represented as JSON:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "asset-urls": {}\n}\n')),(0,l.kt)("p",null,"The default configuration of a feature can be changed by experiments, rollouts and within the manifest itself."),(0,l.kt)("p",null,"However, these changes are performed by ",(0,l.kt)("em",{parentName:"p"},"patching")," the default config, rather than by ",(0,l.kt)("em",{parentName:"p"},"replacement"),"."),(0,l.kt)("p",null,"The algorithm for patching is given by the ",(0,l.kt)("a",{parentName:"p",href:"https://datatracker.ietf.org/doc/html/rfc7396"},"JSON Merge Patch RFC7396"),", which is approximately: JSON objects get merged,\nand scalars and lists are replaced, and ",(0,l.kt)("inlineCode",{parentName:"p"},"null")," causes a deletion."),(0,l.kt)("p",null,"We'll continue our example to illustrate this in more detail:"),(0,l.kt)("p",null,"In the release population, the default JSON for the the ",(0,l.kt)("inlineCode",{parentName:"p"},"theming-feature")," patched on to the minimal configuration above:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "asset-urls": {\n        "default-theme": "https://www.mozilla.com/assets/wp-default/600/900"\n    }\n}\n')),(0,l.kt)("p",null,"This came from a channel specific default within the manifest itself."),(0,l.kt)("p",null,"Some of the release population may be under experiment. An experiment branch sets up the feature thus:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "asset-urls": {\n        "protocol-theme": "https://www.mozilla.com/assets/wp-protocol/600/900"\n    }\n}\n')),(0,l.kt)("p",null,"At the same time, another experiment may have just terminated, and a branch declared the winner. The experiment owner has decided to promote this branch to the whole population as a rollout."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "asset-urls": {\n        "ufi-theme": "https://www.mozilla.com/assets/wp-ufi/600/900"\n    }\n}\n')),(0,l.kt)("p",null,"So the final configuration that the app receives for the feature is a merging of all three:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "asset-urls": {\n        "default-theme": "https://www.mozilla.com/assets/wp-default/600/900",\n        "protocol-theme": "https://www.mozilla.com/assets/wp-protocol/600/900",\n        "ufi-theme": "https://www.mozilla.com/assets/wp-ufi/600/900"\n    }\n}\n')),(0,l.kt)("p",null,"As long as the keys are unique, the collection will grow each time a rollout or experiment affects the feature."),(0,l.kt)("p",null,"Finally, successful rollouts are likely going to be persisted: now we have learned a particular asset performs well, we should make it part of the next release."),(0,l.kt)("p",null,"On the next release, rollouts of successful assets would likely be folded back into the manifest itself, and so the manifest becomes the repository of successful assets."),(0,l.kt)("p",null,"As time goes by, we have a growing collection of asset-urls, without needing to change the code at all."),(0,l.kt)("p",null,'This is a very powerful pattern which is used in multiple places, so we\'ll name this pattern "Growable Collections".'),(0,l.kt)("h3",{id:"exposure-events"},"Exposure events"),(0,l.kt)("p",null,"Features with a growable collection of things may need to give some care about exposure events."),(0,l.kt)("p",null,"Recall: exposure events should be sent when the user is exposed to the treatment."),(0,l.kt)("p",null,"If we wish to experiment with a particular asset, the application feature should detect which asset being shown, and then only\nrecord an exposure only when that asset is being shown. We can do this by adding an extra variable into the feature."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"      asset-under-experiment:\n        description: The key into the asset urls map of the asset we wish to test.\n        type: Option<String>\n        default: null\n")),(0,l.kt)("p",null,"This allows us to be specific in the experiment payload that the ",(0,l.kt)("inlineCode",{parentName:"p"},"protocol-theme")," is the asset we wish to experiment with."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "asset-urls": {\n        "protocol-theme": "https://www.mozilla.com/assets/wp-protocol/600/900"\n    },\n    "asset-under-experiment": "protocol-theme"\n}\n')),(0,l.kt)("p",null,"In the application code, we check to see if the asset being displayed is the one we're interested in, and only then record an exposure."),(0,l.kt)(r.Z,{defaultValue:"swift",values:[{label:"Swift",value:"swift"},{label:"Kotlin",value:"kotlin"}],mdxType:"Tabs"},(0,l.kt)(o.Z,{value:"swift",mdxType:"TabItem"},(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-swift"},"let config = MyNimbus.features.themingFeature.value()\nlet key = selectKey(from: themingFeature.assetMap)\n\nif key == config.assetUnderExperiment {\n    MyNimbus.features.themingFeature.recordExposure()\n}\n\ndisplayAsset(url: config.assetMap[key])\n"))),(0,l.kt)(o.Z,{value:"kotlin",mdxType:"TabItem"},(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-kotlin"},"val config = MyNimbus.features.themingFeature.value()\nval key = selectKey(from: themingFeature.assetMap)\n\nif (key == config.assetUnderExperiment) {\n    MyNimbus.features.themingFeature.recordExposure()\n}\n\ndisplayAsset(config.assetMap[key])\n")))),(0,l.kt)("h3",{id:"local-development"},"Local development"),(0,l.kt)("p",null,"Channel specific ",(0,l.kt)("inlineCode",{parentName:"p"},"defaults")," allow us to specify a list of assets prepopulated with placeholders. The defaults for the\n",(0,l.kt)("inlineCode",{parentName:"p"},"debug")," channel for this feature are derived directly from manifest."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "assets-urls": {\n        "kittens": "https://placekitten.com/600/900",\n        "bill-murray": "https://www.fillmurray.com/600/900",\n        "flickr": "https://loremflickr.com/600/900"\n    }\n}\n')),(0,l.kt)("p",null,"Local development can then proceed with these placeholders, while other channels do not."))}d.isMDXComponent=!0}}]);