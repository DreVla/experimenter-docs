<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="search" type="application/opensearchdescription+xml" title="Experimenter Docs" href="/opensearch.xml"><title data-react-helmet="true">Getting Started for Android Engineers | Experimenter Docs</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://experimenter.info/getting-started/engineers/getting-started-for-android-engineers"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Getting Started for Android Engineers | Experimenter Docs"><meta data-react-helmet="true" name="description" content="Nimbus is an experimentation platform from Mozilla."><meta data-react-helmet="true" property="og:description" content="Nimbus is an experimentation platform from Mozilla."><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://experimenter.info/getting-started/engineers/getting-started-for-android-engineers"><link data-react-helmet="true" rel="alternate" href="https://experimenter.info/getting-started/engineers/getting-started-for-android-engineers" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://experimenter.info/getting-started/engineers/getting-started-for-android-engineers" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.3554915a.css">
<link rel="preload" href="/assets/js/runtime~main.beb85457.js" as="script">
<link rel="preload" href="/assets/js/main.0ae52599.js" as="script">
</head>
<body>
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Experimenter Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo-dark.svg" alt="Experimenter Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Mozilla Experimentation and Feature Delivery</b></a></div><div class="navbar__items navbar__items--right"><a href="https://experimenter.services.mozilla.com/nimbus/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Nimbus<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://mozilla-hub.atlassian.net/wiki/spaces/FJT/pages/11470446/Nimbus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Confluence<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/mozilla/experimenter-docs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="searchBox_1Doo"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Welcome</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">What&#x27;s Newsletter</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Getting Started</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/access">Experiment Reviewers</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Data Scientists</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">Engineers</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/getting-started/engineers/getting-started-for-android-engineers">Getting Started for Android Engineers</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/desktop-feature-api">Desktop Feature API (JS and C++)</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/desktop-migration-guide">Desktop Migration Guide (JS)</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/getting-started/engineers/for-engineers">Getting started with implementation</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/getting-started/engineers/getting-started-for-ios-engineers">Getting Started for iOS Engineers</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/getting-started/engineers/getting-started-mobile-required-ui">Required UI for Mobile Integration</a></li></ul></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/for-product">Product Managers</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/for-leadership">Leadership</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Experimentation Workflow</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Deep Dives</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Experimentation Cookbook</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Frequently Asked Questions</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/glossary">Glossary</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Additional Links</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_1CGd"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_3E-R"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Introduction</h1></header><p>Nimbus is an experimentation platform from Mozilla.</p><p>This document shows you how to set up the Nimbus SDK with a new Android app. It assumes that your app is already using the Glean SDK and Android Components.</p><header><h1>Building with Nimbus</h1></header><p>Nimbus is distributed through bundled Rust code as part of Mozilla&#x27;s Application Services <a href="https://github.com/mozilla/application-services/blob/main/docs/design/megazords.md" target="_blank" rel="noopener noreferrer">&quot;Megazord&quot;</a>.</p><p>In <code>app/build.gradle</code>, in the <code>dependencies</code> block, include the <code>implementation</code> line for Nimbus:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly gradle"><pre tabindex="0" class="prism-code language-gradle codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">dependencies {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    …</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    implementation &quot;org.mozilla.appservices:nimbus:${Versions.mozilla_appservices}&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    …</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="building-with-the-nimbus-fml-gradle-plugin"></a>Building with the Nimbus FML gradle plugin<a class="hash-link" href="#building-with-the-nimbus-fml-gradle-plugin" title="Direct link to heading">#</a></h2><p>The <a href="/fml-spec">Feature Manifest Language</a> provides type-safe access to configuration coming out of the Nimbus SDK, and is used to configure your application features, by
generating Kotlin from a Feature Manifest.</p><p>The <code>tooling-nimbus-gradle</code> plugin manages the download of the tooling, the generating of the Kotlin code, and is configured by gradle.</p><p>In your top-level <code>build.gradle</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly gradle"><pre tabindex="0" class="prism-code language-gradle codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">buildscript {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    dependencies {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        classpath &quot;org.mozilla.appservices:tooling-nimbus-gradle:${Versions.mozilla_appservices}&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>and in <code>app/build.gradle</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly gradle"><pre tabindex="0" class="prism-code language-gradle codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">apply plugin: &quot;org.mozilla.appservices.nimbus-gradle-plugin&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">nimbus {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // The path to the Nimbus feature manifest file</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    manifestFile = &quot;nimbus.fml.yaml&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // Map from the variant name to the channel as experimenter and nimbus understand it.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // If nimbus&#x27;s channels were accurately set up well for this project, then this</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // shouldn&#x27;t be needed.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    channels = [</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            debug: &quot;debug&quot;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            nightly: &quot;nightly&quot;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            beta: &quot;beta&quot;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            release: &quot;release&quot;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ]</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // This is generated by the FML and should be checked into git.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // It will be fetched by Experimenter (the Nimbus experiment website)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // and used to inform experiment configuration.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    //</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // *NOTE*: This value is optional, and is not necessary when Nimbus is being used</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // as part of a library.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    experimenterManifest = &quot;.experimenter.yaml&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // This is an optional value, and updates the plugin to use a copy of application</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // services. The path should be relative to the root project directory.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // *NOTE*: This example will not work for all projects, but should work for Fenix, Focus, and Android Components</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    applicationServicesDir = gradle.hasProperty(&#x27;localProperties.autoPublish.application-services.dir&#x27;) </span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        ? gradle.getProperty(&#x27;localProperties.autoPublish.application-services.dir&#x27;) : null</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>In this case, it should generate a file named in the <code>nimbus.fml.yaml</code> file. In the case of Fenix, this is called <code>FxNimbus</code>.</p><header><h1>The start-up sequence</h1></header><p>Before using Nimbus in your Android app, you need to start it.</p><p>The Nimbus SDK is a configuration store, making configuration available to the any thread, and — to a first approximation— to be immutable within the same session of the app.</p><p>For this reason, we want to be starting the Nimbus SDK as close to the beginning of the start of the app as possible.</p><p>In Firefox for Android and Focus for Android, this is done at the beginning of the <code>Application#onCreate()</code> method.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">class MyApplication: Application() {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    lateinit var nimbus: NimbusInterface</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    override fun onCreate() {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        beginNimbusSetup()</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        // do the rest of the set up here.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        finishNimbusSetup()</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    fun beginNimbusSetup() {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        Megazord.init()</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        nimbus = createNimbus(this, NIMBUS_REMOTE_SETTINGS_ENDPOINT)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    fun finishNimbusSetup() {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        nimbus.fetchExperiments()</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    fun createNimbus(context: Context, urlString: String): NimbusInterface {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        val isAppFirstRun = context.settings().isFirstRun</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        val customTargetingAttibutes = JSONObject().apply {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            // Put any custom attributes you want to use to segment an audience on to</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            // target your experiments.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            put(&quot;is_first_run&quot;, isAppFirstRun)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        val appInfo = NimbusAppInfo(</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            appName = &quot;my-app-name&quot;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            channel = BuildConfig.BUILD_TYPE,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            customTargetingAttributes = customTargetingAttributes</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        )</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        // Use the Nimbus builder to build a NimbusInterface object.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        return NimbusBuilder(context).apply {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            url = urlString</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            errorReporter = { message, e -&gt;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                Logger.error(&quot;Nimbus error: $message&quot;, e)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }.build(appInfo)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Notes:</p><ol><li><code>Megazord.init()</code> is called before <code>createNimbus()</code>.</li><li><code>createNimbus</code> uses a <code>NimbusBuilder</code> to create the Nimbus object.</li><li>We build a <code>JSONObject</code> of custom targeting attributes.</li><li>The <code>nimbus.fetchExperiments()</code> method is called sometime at or after the app has started.</li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="nimbusbuilder-configuration"></a><code>NimbusBuilder</code> configuration<a class="hash-link" href="#nimbusbuilder-configuration" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="getting-errors-out-of-nimbus"></a>Getting errors out of <code>Nimbus</code><a class="hash-link" href="#getting-errors-out-of-nimbus" title="Direct link to heading">#</a></h3><p>By design, Nimbus is deliberately unobtrusive; if it fails then it should not crash, but continue as if not enrolled in any experiments.</p><p>The <code>errorReporter</code> callback is there to connect <code>Nimbus</code> to any error reporting framework in the rest of the app.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">    return NimbusBuilder(context).apply {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        // …</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        errorReporter = { message, e -&gt;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            Logger.error(&quot;Nimbus error: $message&quot;, e)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        // …</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }.build(appInfo)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="connecting-the-nimbusinterface-to-fml-generated-code"></a>Connecting the <code>NimbusInterface</code> to FML generated code<a class="hash-link" href="#connecting-the-nimbusinterface-to-fml-generated-code" title="Direct link to heading">#</a></h3><p>The FML generated code has a runtime dependency on the <code>NimbusInterface</code>.</p><p>To connect it to the Nimbus object, we need to tell the <code>NimbusBuilder</code>. In this case, the generated class is <code>FxNimbus</code>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">    return NimbusBuilder(context).apply {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        // …</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        // Connect FxNimbus to the Nimbus SDK.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        featureManifest = FxNimbus</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        // …</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }.build(appInfo)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="handling-first-run-experiments"></a>Handling First Run experiments<a class="hash-link" href="#handling-first-run-experiments" title="Direct link to heading">#</a></h3><p>Since <code>fetchExperiments</code> from the remote settings URL is slow, and we wish to be able have access to the Nimbus experimental configuration as early in start up as possible, Nimbus downloads and caches the experiment recipes on the <code>n</code>th run of the app and only applies them and makes them available to the app at the beginning of the <em>next</em> i.e. the <code>(n + 1)</code>th run of the app.</p><p>Astute readers will notice that when <code>n = 0</code>, i.e. the very first time the app is run, there are no experiment recipes downloaded. If Remote Settings experiment recipes JSON payload is available as a <code>raw/</code> resource, it can be loaded in at first run:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">    return NimbusBuilder(context).apply {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        // …</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        isFirstRun = isAppFirstRun</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        initialExperiments = R.raw.initial_experiments</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        timeoutLoadingExperiment = TIME_OUT_LOADING_EXPERIMENT_FROM_DISK_MS // defaults to 200 (ms)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        // …</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }.build(appInfo)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The <code>initial_experiments.json</code> file can be downloaded, either as part of the build, or in an automated/timed job. e.g. this is the <a href="https://github.com/mozilla-mobile/fenix/blob/main/.github/workflows/fenix-update-nimbus-experiments.yml" target="_blank" rel="noopener noreferrer">Github Action workflow used by Fenix</a>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="using-the-experiments-preview-collection"></a>Using the experiments preview collection<a class="hash-link" href="#using-the-experiments-preview-collection" title="Direct link to heading">#</a></h3><p>The preview collection is a staging area for new experiments to be tested on the device. This should be toggleable via the UI, but should trigger a restart.</p><p>Adding the <code>usePreviewCollection</code> flag allows the builder to configure a <code>NimbusInterface</code> object connected to the experiment recipes in the preview collection.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">        // Use the Nimbus builder to build a NimbusInterface object.</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        return NimbusBuilder(context).apply {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            // …</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            usePreviewCollection = context.settings().nimbusUsePreview</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            // …</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }.build(appInfo)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="a-complete-nimbusbuilder-example"></a>A complete <code>NimbusBuilder</code> example<a class="hash-link" href="#a-complete-nimbusbuilder-example" title="Direct link to heading">#</a></h2><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">    return NimbusBuilder(context).apply {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        url = urlString</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        errorReporter = { message, e -&gt;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            Logger.error(&quot;Nimbus error: $message&quot;, e)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        initialExperiments = R.raw.initial_experiments</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        usePreviewCollection = context.settings().nimbusUsePreview</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        isFirstRun = isAppFirstRun</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        onCreateCallback = { nimbus -&gt;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            FxNimbus.initialize { nimbus }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        onApplyCallback = {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            FxNimbus.invalidateCachedValues()</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }.build(appInfo)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="instrumenting-the-app-for-testing"></a>Instrumenting the app for testing<a class="hash-link" href="#instrumenting-the-app-for-testing" title="Direct link to heading">#</a></h2><p>The <a href="https://github.com/mozilla/application-services/tree/main/components/support/nimbus-cli" target="_blank" rel="noopener noreferrer"><code>nimbus-cli</code></a> allows QA and engineers to launch the app in different experimental configurations. It largely obviates the need for configuring Nimbus to use the preview collection, above.</p><p>To connect the <code>NimbusInterface</code> object to the command line, we need to feed the intent from the app&#x27;s launch activity to the <code>NimbusInterface</code>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">import org.mozilla.experiments.nimbus.initializeTooling</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">open class HomeActivity : AppCompatActivity() {)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    override fun onCreate(savedInstanceState: Bundle?) {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        // Find the nimbus singleton</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        val app = application as MyApplication</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        val nimbus = app.nimbus</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        // Pass it the launch intent</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        nimbus.initializeTooling(applicationContext, intent)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        // …</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/mozilla/experimenter-docs/edit/main/docs/getting-started/engineers/android-integration.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/validating-experiments"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Validating Experiments</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/desktop-feature-api"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Desktop Feature API (JS and C++) »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#building-with-the-nimbus-fml-gradle-plugin" class="table-of-contents__link">Building with the Nimbus FML gradle plugin</a></li><li><a href="#nimbusbuilder-configuration" class="table-of-contents__link"><code>NimbusBuilder</code> configuration</a><ul><li><a href="#getting-errors-out-of-nimbus" class="table-of-contents__link">Getting errors out of <code>Nimbus</code></a></li><li><a href="#connecting-the-nimbusinterface-to-fml-generated-code" class="table-of-contents__link">Connecting the <code>NimbusInterface</code> to FML generated code</a></li><li><a href="#handling-first-run-experiments" class="table-of-contents__link">Handling First Run experiments</a></li><li><a href="#using-the-experiments-preview-collection" class="table-of-contents__link">Using the experiments preview collection</a></li></ul></li><li><a href="#a-complete-nimbusbuilder-example" class="table-of-contents__link">A complete <code>NimbusBuilder</code> example</a></li><li><a href="#instrumenting-the-app-for-testing" class="table-of-contents__link">Instrumenting the app for testing</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Mozilla Corporation</div></div></div></footer></div>
<script src="/assets/js/runtime~main.beb85457.js"></script>
<script src="/assets/js/main.0ae52599.js"></script>
</body>
</html>