<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="search" type="application/opensearchdescription+xml" title="Experimenter Docs" href="/opensearch.xml"><title data-react-helmet="true">Jetstream Architecture and Operations | Experimenter Docs</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://experimenter.info/jetstream/operations"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Jetstream Architecture and Operations | Experimenter Docs"><meta data-react-helmet="true" name="description" content="[Jetstream] is part of the Cirrus ecosystem and depends on some external services."><meta data-react-helmet="true" property="og:description" content="[Jetstream] is part of the Cirrus ecosystem and depends on some external services."><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://experimenter.info/jetstream/operations"><link data-react-helmet="true" rel="alternate" href="https://experimenter.info/jetstream/operations" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://experimenter.info/jetstream/operations" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.4e4a976a.css">
<link rel="preload" href="/assets/js/runtime~main.56098510.js" as="script">
<link rel="preload" href="/assets/js/main.ae154802.js" as="script">
</head>
<body>
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Experimenter Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo-dark.svg" alt="Experimenter Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Mozilla Experimentation and Feature Delivery</b></a></div><div class="navbar__items navbar__items--right"><a href="https://experimenter.services.mozilla.com/nimbus/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Nimbus<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://mana.mozilla.org/wiki/display/FJT/Project+Nimbus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Mana<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/mozilla/experimenter-docs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="searchBox_1Doo"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Welcome</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">What&#x27;s Newsletter</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Getting Started</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Experimentation Workflow</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Deep Dives</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">Jetstream</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/jetstream/jetstream">Jetstream overview</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/jetstream/metrics">Metrics</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/jetstream/statistics">Statistics</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/jetstream/outcomes">Outcomes</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/jetstream/configuration">Configuring Jetstream</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/jetstream/data-products">Jetstream Data Products</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/jetstream/operations">Jetstream Architecture and Operations</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/jetstream/troubleshooting">Troubleshooting Jetstream</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a href="https://github.com/mozilla/jetstream" target="_blank" rel="noopener noreferrer" class="menu__link" tabindex="0"><span>GitHub Repo<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Data topics</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Desktop topics</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Mobile topics</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Experimenter topics</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Specifications</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Experimentation Cookbook</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Additional Links</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Frequently Asked Questions</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_1CGd"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_3E-R"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Jetstream Architecture and Operations</h1></header><p><strong><a href="https://github.com/mozilla/jetstream" target="_blank" rel="noopener noreferrer">Jetstream</a></strong> is part of the Cirrus ecosystem and depends on some external services.</p><p><img alt="Cirrus overview" src="/assets/images/cirrus-dcec78c0add8c3ecd5a47581ab99fa92.png">
<em>High-level overview of Cirrus</em></p><p>Jetstream is <a href="https://github.com/mozilla/telemetry-airflow/blob/e5de501d8063cc366e9bb546135f3866136cb47d/dags/jetstream.py#L22" target="_blank" rel="noopener noreferrer">scheduled to run in Airflow</a> daily. The daily runs will analyze all experiments that are currently active or just ended the day before and write metrics, statistics and errors for each experiment to BigQuery. Active V1 experiments and V6 experiments (Nimbus experiments) are retrieved from the <a href="https://experimenter.services.mozilla.com/api/v1/experiments/" target="_blank" rel="noopener noreferrer">Experimenter API</a>.</p><p>Jetstream also fetches custom experiment and outcome configs from <a href="https://github.com/mozilla/jetstream-config" target="_blank" rel="noopener noreferrer">jetstream-config</a> for analysis. When a new custom config gets merged into jetstream-config, the CI will trigger Jetstream to re-run all analyses for the experiment affected by the config. CircleCI will report on the status of the analysis run and link to the Cloud Logging logs.</p><p>After writing analyses results to BigQuery, statistics data is exported to the <code>mozanalysis</code> bucket in GCS as JSON. The JSON data is accessed by the analysis dashboard to display results.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="architecture-for-scaling-jetstream"></a>Architecture for Scaling Jetstream<a class="hash-link" href="#architecture-for-scaling-jetstream" title="Direct link to heading">#</a></h2><p>To ensure analysis results are available in a timely manner, Jetstream implements two approaches for reducing the time required to run experiment analyses:</p><ul><li>Parallelization of experiment analyses using <a href="https://argoproj.github.io/" target="_blank" rel="noopener noreferrer">Argo</a></li><li>Parallelization of lower-level calculations (statistics, segments, ...) using <a href="https://dask.org/" target="_blank" rel="noopener noreferrer">Dask</a></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="parallelizing-experiment-analyses"></a>Parallelizing experiment analyses<a class="hash-link" href="#parallelizing-experiment-analyses" title="Direct link to heading">#</a></h3><p><a href="https://argoproj.github.io/" target="_blank" rel="noopener noreferrer">Argo</a> is a light-weight workflow engine for orchestrating parallel jobs on Kubernetes and is capable of creating tasks dynamically that will be executed in parallel. Using Argo, the analyses for different experiments and analysis dates are split into separate jobs that run in parallel on the <code>jetstream</code> Kubernetes cluster in the <code>moz-fx-data-experiment-analysis</code> GCP project.</p><p>Argo expects each step in the workflow to be a container. The existing Jetstream container, which has the Jetstream CLI installed, can be used for each of these steps.
The full workflow definition is defined in <a href="https://github.com/mozilla/jetstream/blob/main/jetstream/workflows/run.yaml" target="_blank" rel="noopener noreferrer">the <code>workflows/run.yaml</code> file</a>.</p><p>Depending on how Jetstream is invoked (<code>rerun</code>, <code>run-argo</code>, or <code>rerun_config_changed</code>), Jetstream will determine the dates and experiments that are to be analyzed and injects them as parameters into <code>run.yaml</code> before launching the workflow. Argo will create separate jobs for each experiment and each analysis date. Once the analysis is complete, data gets exported as JSON to GCS.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="parallelizing-lower-level-calculations"></a>Parallelizing lower-level calculations<a class="hash-link" href="#parallelizing-lower-level-calculations" title="Direct link to heading">#</a></h3><p>In addition to running experiment analyses in parallel, <a href="https://dask.org/" target="_blank" rel="noopener noreferrer">Dask</a> is used to parallelize lower-level calculations. The following steps could be executed in parallel:</p><ul><li>Analyses for each analysis period (daily, 28day, weekly, overall)</li><li>Analyses for different segments</li><li>Calculating statistics defined for an experiment analysis</li></ul><p>The <a href="https://docs.dask.org/en/latest/delayed.html" target="_blank" rel="noopener noreferrer"><code>dask.delayed interface</code></a> is used to turn the functions executing these steps into tasks that are added to a task graph which executes these steps in parallel. Dask is configured to use as many cores as are available on the machine by default, with 1 worker for each core. <a href="https://docs.dask.org/en/latest/scheduling.html#local-threads" target="_blank" rel="noopener noreferrer">Multi-threading being avoided, instead processes are used</a> since the code is dominated by Python code, otherwise there wouldn&#x27;t be any speedup due Python&#x27;s Global Interpreter Lock. To manually restrict the number of processes, the <code>JETSTREAM_PROCESSES</code> environment variable can be used.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="setup"></a>Setup<a class="hash-link" href="#setup" title="Direct link to heading">#</a></h2><p>Jetstream is executed on the <code>jetstream</code> Kubernetes cluster in the <code>moz-fx-data-experiments</code> project which is set up following <a href="https://github.com/argoproj/argo/blob/master/docs/quick-start.md" target="_blank" rel="noopener noreferrer">Argo&#x27;s installation guide</a>:</p><ul><li>When creating or re-creating the cluster, BigQuery and Compute Engine read/write permissions need to be enabled</li><li>Installing Argo:<ul><li>Create an <code>argo</code> namespace: <code>kubectl create ns argo</code></li><li>Install commonly used components: <code>kubectl apply -n argo -f https://raw.githubusercontent.com/argoproj/argo/stable/manifests/quick-start-postgres.yaml</code></li><li>Create new <code>clusterrole</code>: <code>kubectl create rolebinding default-admin --clusterrole=admin --serviceaccount=argo:default --namespace=argo</code></li></ul></li><li>The <a href="https://github.com/mozilla/telemetry-airflow/blob/master/dags/jetstream.py" target="_blank" rel="noopener noreferrer"><code>jetstream</code> DAG in Airflow</a> triggers the <code>run-argo</code> job daily and either requires Compute Engine API access or the parameters <code>cluster_ip</code> and <code>cluster_cert</code> need to be provided<ul><li>Currently the Airflow cluster does not have Compute Engine API access, so the cluster IP and certificate are stored as secrets and used for running Jetstream</li></ul></li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/mozilla/experimenter-docs/edit/main/docs/jetstream/operations.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/jetstream/data-products"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Jetstream Data Products</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/jetstream/troubleshooting"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Troubleshooting Jetstream »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#architecture-for-scaling-jetstream" class="table-of-contents__link">Architecture for Scaling Jetstream</a><ul><li><a href="#parallelizing-experiment-analyses" class="table-of-contents__link">Parallelizing experiment analyses</a></li><li><a href="#parallelizing-lower-level-calculations" class="table-of-contents__link">Parallelizing lower-level calculations</a></li></ul></li><li><a href="#setup" class="table-of-contents__link">Setup</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Mozilla Corporation</div></div></div></footer></div>
<script src="/assets/js/runtime~main.56098510.js"></script>
<script src="/assets/js/main.ae154802.js"></script>
</body>
</html>