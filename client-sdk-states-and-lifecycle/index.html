<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="search" type="application/opensearchdescription+xml" title="Experimenter Docs" href="/opensearch.xml"><title data-react-helmet="true">Client SDK States &amp; Lifecycle | Experimenter Docs</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://experimenter.info/client-sdk-states-and-lifecycle"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Client SDK States &amp; Lifecycle | Experimenter Docs"><meta data-react-helmet="true" name="description" content="Nimbus SDK Experiment States and Lifecycle"><meta data-react-helmet="true" property="og:description" content="Nimbus SDK Experiment States and Lifecycle"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://experimenter.info/client-sdk-states-and-lifecycle"><link data-react-helmet="true" rel="alternate" href="https://experimenter.info/client-sdk-states-and-lifecycle" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://experimenter.info/client-sdk-states-and-lifecycle" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.4e4a976a.css">
<link rel="preload" href="/assets/js/runtime~main.90a1e22e.js" as="script">
<link rel="preload" href="/assets/js/main.ae154802.js" as="script">
</head>
<body>
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Experimenter Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo-dark.svg" alt="Experimenter Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Mozilla Experimentation and Feature Delivery</b></a></div><div class="navbar__items navbar__items--right"><a href="https://experimenter.services.mozilla.com/nimbus/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Nimbus<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://mana.mozilla.org/wiki/display/FJT/Project+Nimbus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Mana<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/mozilla/experimenter-docs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="searchBox_1Doo"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Welcome</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">What&#x27;s Newsletter</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Getting Started</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Experimentation Workflow</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Deep Dives</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Jetstream</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Data topics</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Desktop topics</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Mobile topics</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Experimenter topics</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">Specifications</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/client-sdk-states-and-lifecycle">Client SDK States &amp; Lifecycle</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/fm-unimplemented-spec">Proposed changes for Feature Manifest Language</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/fml-cli">Nimbus FML command line interface</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/fml-front-end-format">Feature Manifest Language Front-end Format As YAML</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/fml-imports-and-includes">Componentizing the Nimbus Feature Manifest</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/fml-paths">Using paths in FML</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/fml-spec">The Feature Manifest Language spec</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Experimentation Cookbook</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Additional Links</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Frequently Asked Questions</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_1CGd"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_3E-R"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Client SDK States &amp; Lifecycle</h1></header><p>Nimbus SDK Experiment States and Lifecycle</p><h6><a aria-hidden="true" tabindex="-1" class="anchor anchor__h6 anchorWithStickyNavbar_31ik" id="authors-ryan-kelly"></a>Authors: Ryan Kelly<a class="hash-link" href="#authors-ryan-kelly" title="Direct link to heading">#</a></h6><h6><a aria-hidden="true" tabindex="-1" class="anchor anchor__h6 anchorWithStickyNavbar_31ik" id="reviewers-kate-hudson-tim-smith"></a>Reviewers: Kate Hudson, Tim Smith<a class="hash-link" href="#reviewers-kate-hudson-tim-smith" title="Direct link to heading">#</a></h6><h6><a aria-hidden="true" tabindex="-1" class="anchor anchor__h6 anchorWithStickyNavbar_31ik" id="status-draft-as-of-november-2020-see-the-changelog-for-updates"></a>Status: Draft as of November 2020; see the <a href="#changelog">changelog</a> for updates<a class="hash-link" href="#status-draft-as-of-november-2020-see-the-changelog-for-updates" title="Direct link to heading">#</a></h6><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="introduction"></a>Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">#</a></h2><p>This document provides a high-level overview of the lifecycle of a Nimbus experiment, from the point of view of the client SDK. It&#x27;s in part an adjunct to the <a href="https://github.com/mozilla/experimenter/tree/main/app/experimenter/kinto#experiment-states" target="_blank" rel="noopener noreferrer">Nimbus Experiment Publishing Lifecycle</a>.</p><p>The <a href="#client-behaviors">behaviour of API calls</a> to the Client SDK will
depend on both the last observed <a href="#server-side-experiment-states">server-side experiment
state</a>, and the current <a href="#client-side-experiment-states">local client
state</a>, and the SDK will <a href="#telemetry">emit
telemetry</a> based on the local state of each
experiment.</p><p>I happen to think that these states could map nicely to some Rust Enums, but your mileage may vary.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="key-concepts"></a>Key Concepts<a class="hash-link" href="#key-concepts" title="Direct link to heading">#</a></h2><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="treatment"></a>Treatment<a class="hash-link" href="#treatment" title="Direct link to heading">#</a></h4><p>We&#x27;ll use &quot;treatment&quot; to refer to the change in client behaviour that&#x27;s triggered by an experiment. This might be a small change in colour or wording, or may provide some much larger piece of new UX. The details and scope don&#x27;t matter for our purposes here, what matters is having a word that means &quot;the user is experiencing the effects of the experiment&quot;.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="enrollment"></a>Enrollment<a class="hash-link" href="#enrollment" title="Direct link to heading">#</a></h4><p>Enrollment is the process of the client SDK deciding whether this client should be part of the experiment and if so, what branch it should be assigned to. We&#x27;ll emit an <a href="https://mana.mozilla.org/wiki/display/FJT/Nimbus+Engineering#NimbusEngineering-ExperimentTelemetry" target="_blank" rel="noopener noreferrer">enrollment</a> telemetry event when this happens.</p><p>Once a client is enrolled in an experiment, it will tag its telemetry pings with that experiment and branch information so that they can be identified for analysis.</p><p>Enrolled clients will remain enrolled and assigned to the same branch until the experiment ends, or until they reset their experiment state by disabling telemetry. A client may <em>disable the treatment</em> under various circumstances, but it&#x27;s important that it continue reporting that it was enrolled in the experiment, to <a href="https://docs.google.com/document/d/18Vdn4zZX2D1u9AqzHRY0lUSUbpBdouqWtVp3Bu8vYQA/" target="_blank" rel="noopener noreferrer">help with data analysis</a>.</p><p>Note that it&#x27;s possible for an experiment to be closed for new enrollments, while continuing to be active for and showing its treatment to previously-enrolled clients.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="exposure"></a>Exposure<a class="hash-link" href="#exposure" title="Direct link to heading">#</a></h4><p>Exposure is the process of actually showing the treatment. In other words, it&#x27;s when we change client behaviour based on the experiment branch in which the client was enrolled, or when we <em>would</em> have changed behaviour if the user was not in the control group. We&#x27;ll emit an <a href="https://mana.mozilla.org/wiki/display/FJT/Nimbus+Engineering#NimbusEngineering-ExperimentTelemetry" target="_blank" rel="noopener noreferrer">exposure</a> telemetry event the first time this happens.</p><p>Note that it&#x27;s possible for a client to be enrolled in an experiment but never be exposed to its treatment, for example if the user never uses the part of the client app that is affected by the treatment.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="disqualification"></a>Disqualification<a class="hash-link" href="#disqualification" title="Direct link to heading">#</a></h4><p>After a client is enrolled in an experiment, we may need to disable that experiment&#x27;s treatment for various reasons, such as:</p><ul><li>The user explicitly opts out of the experiment, or of all experiments.</li><li>The application code detects that it cannot show the treatment.</li><li>The targeting parameters change in a way that excludes the client.</li></ul><p>We&#x27;ll emit a telemetry event when this happens.</p><p>Importantly, if the client was already enrolled in an experiment, then it will continue to tag its telemetry pings with the enrolled experiment and branch information, even if it has become disqualified.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="server-side-experiment-states"></a>Server-Side Experiment States<a class="hash-link" href="#server-side-experiment-states" title="Direct link to heading">#</a></h2><p>The Nimbus experiment publishing workflow moves each experiment through several different states, reflected in the experiment data published to the Remote Settings server. Transitions between the states are triggered by updates published to Remote Settings. (TODO: maybe also by the passage of time as observed by the RS server?)</p><p>Note that we are only interested in states that are observable by the client; the experiment publishing workflow has additional states for internal use that are not represented here.</p><p><img alt="drawing" src="/assets/images/client-visible-publishing-workflow-states-c491801bfadd8f5a598a6b23cd91aada.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="the-preparing-state"></a>The &quot;Preparing&quot; State<a class="hash-link" href="#the-preparing-state" title="Direct link to heading">#</a></h4><p>Before an experiment becomes visible to clients in Remote Settings, it may go through a series of drafts and adjustments and approvals in the Experimenter console. This is represented in the server-side workflow by several different states, but since it is completely invisible to the Client SDK these will not be discussed further in this document.</p><p>Transitions:</p><ul><li>To <strong>Enrolling</strong> state, by being made visible to clients in Remote Settings.</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="the-enrolling-state"></a>The &quot;Enrolling&quot; State<a class="hash-link" href="#the-enrolling-state" title="Direct link to heading">#</a></h4><p>This is the first phase of an experiment going &quot;live&quot; and starting to show up in the user experience. It&#x27;s indicated by the experiment being visible to clients in Remote Settings with <em>isEnrollmentPaused</em> set to <em>false</em>.</p><p>Clients that <em>observe an experiment transition</em> to this state should check whether to enroll in the experiment (N.B. this includes a self-transition from <strong>Enrolling</strong> -&gt; <strong>Enrolling</strong> that is accompanied by a change in the published experiment config, which might change enrollment decisions).</p><p>While the experiment is in this state, enrolled clients should activate the experiment treatment appropriate for their enrolled branch, and report telemetry about it.</p><p>Transitions:</p><ul><li>To <strong>Running</strong> state, when a Remote Settings update changes <em>isEnrollmentPaused</em> to <em>true</em>.</li><li>To <strong>Enrolling</strong> state, when a Remote Settings update changes other experiment parameters.</li><li>To <strong>Ended</strong> state, if the experiment ceases to be visible in Remote Settings.</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="the-running-state"></a>The &quot;Running&quot; State<a class="hash-link" href="#the-running-state" title="Direct link to heading">#</a></h4><p>This is the second phase of an experiment being live and showing up in the user experience. It&#x27;s indicated by the experiment being visible to clients in Remote Settings with <em>isEnrollmentPaused</em> set to <em>true</em>.</p><p>While the experiment is in this state, clients that are <em>not</em> already enrolled in the experiment should not enroll themselves, even if the experiment config changes in a way that would otherwise cause them to enroll. Already-enrolled clients should continue to activate the experiment treatment appropriate for their enrolled branch, and report telemetry about it.</p><p>Transitions:</p><ul><li>To <strong>Enrolling</strong> state, when a Remote Settings update changes <em>isEnrollmentPaused</em> to <em>false</em>.</li><li>To <strong>Running</strong> state, when a Remote Settings update changes other experiment parameters.</li><li>To <strong>Ended</strong> state, if the experiment ceases to be visible in Remote Settings.</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="the-ended-state"></a>The &quot;Ended&quot; State<a class="hash-link" href="#the-ended-state" title="Direct link to heading">#</a></h4><p>An experiment ends when it ceases to be visible to clients in Remote Settings. As with the &quot;Preparing&quot; state, there may be multiple server-side states involved in ending an experiment, but since they are completely invisible to the Client SDK these will not be discussed further in this document.</p><p>Transitions:</p><ul><li>None, this state is terminal.</li></ul><p>Errors:</p><ul><li>TODO: should we log some sort of error if we observe an experiment coming back to life after it was ended?</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="client-side-experiment-states"></a>Client-Side Experiment States<a class="hash-link" href="#client-side-experiment-states" title="Direct link to heading">#</a></h2><p>Each Nimbus client will also have its own local state for each experiment, based on the observed history of the server-side experiment states that it has read from the Remote Settings server. Transitions between the states are triggered by observing experiment config changes when querying the Remote Settings server, and by the passage of time on the client.</p><p><img alt="client-side local states" src="/assets/images/client-side-local-states-481dec490572f78332b3701cafb17f60.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="the-unknown-state"></a>The &quot;Unknown&quot; State<a class="hash-link" href="#the-unknown-state" title="Direct link to heading">#</a></h4><p>Before an experiment is published to Remote Settings, obviously the client SDK can&#x27;t know anything about it. But there may be client code that calls the SDK asking whether to activate treatments for this as-yet-unknown experiment, so it&#x27;s worth representing this state explicitly.</p><p>Transitions:</p><ul><li>To <strong>Enrolled</strong> state,  by observing the experiment in Remote Settings for the first time, the experiment being in <strong>Enrolling</strong> state, and bucketing logic dictating that the client should enroll in a branch of the experiment.</li><li>To <strong>NotEnrolled</strong> state, by observing the experiment in Remote Settings for the first time, but deciding not to enroll based on the observed experiment state or local config.</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="the-notenrolled-state"></a>The &quot;NotEnrolled&quot; State<a class="hash-link" href="#the-notenrolled-state" title="Direct link to heading">#</a></h4><p>In this state, the client has observed the existence of an experiment in Remote Settings and has stored a local copy of the current experiment config, but based on that config has decided not to enroll in the experiment.</p><p>Transitions:</p><ul><li>To <strong>Enrolled</strong> state, when the experiment transitions to <strong>Enrolling</strong> state, and bucketing logic dictates that the client should enroll in a branch of the experiment.<ul><li>(N.B. this includes the experiment transitioning <strong>Enrolling</strong> -&gt; <strong>Enrolling</strong> with an update to the experiment config)</li><li>(N.B. the bucketing logic may depend on the state of other experiments, in the case of conflicts between multiple experiments)</li></ul></li><li>To <strong>Errored</strong> state, encountering some unrecoverable error in the experiment config.</li><li>To <strong>Discarded</strong> state, when the experiment transitions to <strong>Cancelled</strong> or <strong>Completed</strong>.</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="the-enrolled-state"></a>The &quot;Enrolled&quot; State<a class="hash-link" href="#the-enrolled-state" title="Direct link to heading">#</a></h4><p>In this state, the client has previously observed the experiment in <strong>Enrolling</strong> state and has been bucketed into a branch of the experiment. It persists the selected branch so that it can consistently reference it even if the experiment config changes in future.</p><p>Transitions:</p><ul><li>To <strong>Disqualified</strong> state:<ul><li>When the user explicitly opts out of participating in this experiment.</li><li>When the user explicitly opts out of participating in experiments in general.</li><li>When application code makes an explicit API call to disable this experiment.</li><li>When the experiment transitions to <strong>Enrolling</strong> or <strong>Running</strong> state, and its targeting expression no longer matches the client.<ul><li>(N.B. this includes the experiment transitioning <strong>Enrolling</strong> -&gt; <strong>Enrolling</strong> with an update to the experiment config, which can re-trigger bucketing evaluation)</li></ul></li><li>When encountering some unrecoverable error in the experiment config.</li></ul></li><li>To <strong>WasEnrolled</strong> state:<ul><li>When the experiment transitions to <strong>Cancelled</strong> or <strong>Completed</strong><ul><li>(i.e. When a valid response is received from Remote Settings and the experiment is no longer present in the Remote Settings collection).</li></ul></li></ul></li><li>To <strong>Discarded</strong> state, when the user entirely disables telemetry in their client.</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="the-disqualified-state"></a>The &quot;Disqualified&quot; State<a class="hash-link" href="#the-disqualified-state" title="Direct link to heading">#</a></h4><p>In this state, the client had previously enrolled in the experiment, but some change has occurred that means we can no longer show them to experiment treatment. The client will continue to tag its telemetry pings with enrollment data, but will not activate the treatment.</p><p>Transitions:</p><ul><li>To <strong>WasEnrolled</strong> state:<ul><li>When the experiment transitions to <strong>Cancelled</strong> or <strong>Completed</strong><ul><li>(i.e. When a valid response is received from Remote Settings and the experiment is no longer present in the Remote Settings collection).</li></ul></li></ul></li><li>To <strong>Discarded</strong> state, when the user entirely disables telemetry in their client.</li></ul><p>Note that once a client has been disqualified from an experiment, it is not possible for it to be resume showing the experiment treatment.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="the-wasenrolled-state"></a>The &quot;WasEnrolled&quot; State<a class="hash-link" href="#the-wasenrolled-state" title="Direct link to heading">#</a></h4><p>In this state, the client remembers that it was previously enrolled in an experiment and may report diagnostic telemetry about this fact, but the experiment has ended and its treatments are no longer activated.</p><p>WasEnrolled experiments are shown in about:studies:</p><p><img alt="WasEnrolled shown in about:studies" src="/assets/images/WasEnrolled-in-about-studies-9d33603f715b1d7279c8c300adba3372.png" title="WasEnrolled shown in about:studies"></p><p>It&#x27;s also useful for analysis to have a period of observation (say 30 days?) after an experiment ends in which we still tag telemetry pings with the experiment branch info.</p><p>Transitions:</p><ul><li>To <strong>Discarded</strong> state after 31 days have passed since it entered the <strong>WasEnrolled</strong> state, according to the client&#x27;s local clock.</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="the-errored-state"></a>The &quot;Errored&quot; State<a class="hash-link" href="#the-errored-state" title="Direct link to heading">#</a></h4><p>A special state into which the client transitions if it observed any unexpected behaviour, such as invalid experient config or unexpected experiment-state transitions. In this state the client may log diagnostic telemetry but will not enroll in the experiment nor activate any experiment treatments.</p><p>It is not possible to escape this state, except by discarding the experiment information.</p><p>Transitions:</p><ul><li>To <strong>Discarded</strong> state, when the experiment transitions to <strong>Cancelled</strong> or <strong>Completed</strong>.</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="the-discarded-state"></a>The &quot;Discarded&quot; State<a class="hash-link" href="#the-discarded-state" title="Direct link to heading">#</a></h4><p>This isn&#x27;t really a state, it&#x27;s just to mark on the diagram the point at which we discard historical data about the experiment from the client&#x27;s local storage.</p><p>Once the client reaches this state, it stops tagging its telemetry pings with information about the experiment.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="telemetry"></a>Telemetry<a class="hash-link" href="#telemetry" title="Direct link to heading">#</a></h3><p>Nimbus clients will submit telemetry via <a href="https://mozilla.github.io/glean" target="_blank" rel="noopener noreferrer">Glean</a>. The full set of experiment-related telemetry is defined in the <a href="https://mana.mozilla.org/wiki/display/FJT/Nimbus+Engineering#NimbusEngineering-ExperimentTelemetry" target="_blank" rel="noopener noreferrer">Nimbus Engineering Mana page</a>.</p><p>Nimbus will use the <a href="https://mozilla.github.io/glean/book/user/experiments-api.html" target="_blank" rel="noopener noreferrer">Glean Experiments API</a> to tag outgoing metrics pings with information about enrolled experiments:</p><ul><li>After initialization, the Nimbus SDK will list all known experiments in <strong>Enrolled</strong>, <strong>Disqualified </strong>or <strong>WasEnrolled</strong> state and call <code>setExperimentActive(slug, branch)</code> to tag outgoing telemetry pings with the enrolled branch of that experiment.</li><li>When an experiment transitions to <strong>Enrolled</strong> state, the Nimbus SDK will call  <code>setExperimentActive(slug, branch)</code> to tag outgoing telemetry pings with the enrolled branch of the new experiment.</li><li>When an experiment transitions from <strong>WasEnrolled </strong>to <strong>Discarded</strong>, the
Nimbus SDK will call <code>setExperimentInactive(slug)</code> to cease tagging outgoing
telemetry pings with information about the experiment.  Note, that Glean does
not cache or persist the experiment API info, so it&#x27;s important to call
<code>setExperimentActive</code> on every run, preferably close to startup so that
it can annotate any custom pings that may be sent out early during app launch.
The <code>setExperimentInactive</code> only needs to be called if we have called
<code>setExperimentActive</code> for that experiment in the same app run.</li></ul><p>Nimbus will also emit Glean <a href="https://mozilla.github.io/glean/book/user/metrics/event.html" target="_blank" rel="noopener noreferrer">events</a> on key experiment state transitions:</p><ul><li>An &quot;<strong><em>enrollment</em></strong>&quot; event, when an experiment enters the <strong>Enrolled</strong> state.<ul><li>Event field &quot;experiment&quot; records the experiment slug.</li><li>Event field &quot;branch&quot; records the branch into which the client enrolled.</li><li>Event field &quot;enrollmentId&quot; contains a randomly-generated identifier for this enrollment.</li></ul></li><li>A &quot;<strong><em>disqualification</em></strong>&quot; event, when an experiment enters the <strong>Disqualified</strong> state.<ul><li>Event field &quot;experiment&quot; records the experiment slug.</li><li>Event field &quot;branch&quot; records the branch into which the client enrolled.</li><li>Event field &quot;enrollmentId&quot; contains the enrollment id from the corresponding &quot;enrollment&quot; event.</li><li>Event field &quot;reason&quot; containing the reason for disqualification, as one of the following values:<ul><li>&quot;optout&quot;</li><li>&quot;targeting&quot;</li></ul></li></ul></li><li>An &quot;<strong><em>unenrollment</em></strong>&quot; event, when an experiment enters the <strong>WasEnrolled</strong> state.<ul><li>Event field &quot;experiment&quot; records the experiment slug.</li><li>Event field &quot;branch&quot; records the branch into which the client enrolled.</li><li>Event field &quot;enrollmentId&quot; contains the enrollment id from the corresponding &quot;enrollment&quot; event.</li></ul></li></ul><p>Nimbus will also emit Glean <a href="https://mozilla.github.io/glean/book/user/metrics/event.html" target="_blank" rel="noopener noreferrer">events</a> when the client code calls experiment-related APIs:</p><ul><li>An &quot;<strong><em>exposure</em></strong>&quot; event, when client code calls <code>activateExperiment</code> or <code>isFeatureEnabled</code> for the first time, and the experiment is in <strong>Enrolled</strong> state.<ul><li>Event field &quot;experiment&quot; records the experiment slug.</li><li>Event field &quot;branch&quot; records the branch into which the client enrolled.</li><li>Event field &quot;enrollmentId&quot; contains a randomly-generated identifier for this enrollment.</li></ul></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="client-behaviours"></a>Client Behaviours<a class="hash-link" href="#client-behaviours" title="Direct link to heading">#</a></h2><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="when-asked-if-an-experiment-is-active"></a>When asked if an experiment is active<a class="hash-link" href="#when-asked-if-an-experiment-is-active" title="Direct link to heading">#</a></h4><ul><li>Get the current client state and last-seen server state for the named experiment.</li><li>If the client state is <strong>Enrolled</strong>, return <em>true</em>.</li><li>Otherwise, return <em>false</em>.</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="when-asked-for-the-current-branch-of-an-experiment"></a>When asked for the current branch of an experiment<a class="hash-link" href="#when-asked-for-the-current-branch-of-an-experiment" title="Direct link to heading">#</a></h4><ul><li>Get the current client state and last-seen server state for the named experiment.</li><li>If the client state is <strong>Enrolled</strong>, return the enrolled branch and its config.</li><li>Otherwise, return <em>None</em>.</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="when-asked-for-the-current-config-of-a-feature"></a>When asked for the current config of a feature<a class="hash-link" href="#when-asked-for-the-current-config-of-a-feature" title="Direct link to heading">#</a></h4><ul><li>Get the current client state and last-seen server state for all experiments.</li><li>Discard any experiments whose client state is not <strong>Enrolled</strong>.</li><li>For each remaining experiment:<ul><li>Get the branch config for the <strong>Enrolled </strong>branch.</li><li>If it does not contain config for the named feature, discard the experiment</li></ul></li><li>If more than one experiment remains, TODO this is an error right? report it somehow.</li><li>If exactly one experiment remains, return the feature config from its <strong>Enrolled</strong> branch.</li><li>Otherwise, return <em>None</em>.</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="when-a-server-update-transitions-an-experiment-to-enrolling"></a>When a server update transitions an experiment to &quot;Enrolling&quot;<a class="hash-link" href="#when-a-server-update-transitions-an-experiment-to-enrolling" title="Direct link to heading">#</a></h4><ul><li>If the current client state for the experiment is <strong>Unknown</strong> or <strong>NotEnrolled</strong>:<ul><li>Get the current state for all known experiments that conflict with this one.</li><li>Evaluate targeting/bucketing/etc, if it says to enroll, set client state to <strong>Enrolled</strong>.<ul><li>TODO: trigger a notification in the client app somehow, to redraw UI etc?</li></ul></li><li>Otherwise, set client state to <strong>NotEnrolled</strong>.</li></ul></li><li>If the current client state for the experiment is <strong>Enrolled</strong>:<ul><li>TODO: what exactly? How does an existing enrollment change in response to updated experiment config?</li></ul></li><li>Otherwise, set the current client state for the experiment to <strong>Errored</strong> and log some diagnostic telemetry.</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="when-a-server-update-transitions-an-experiment-to-paused-or-running"></a>When a server update transitions an experiment to &quot;Paused&quot; or &quot;Running&quot;<a class="hash-link" href="#when-a-server-update-transitions-an-experiment-to-paused-or-running" title="Direct link to heading">#</a></h4><ul><li>If the current client state for the experiment is <strong>Enrolled</strong>:<ul><li>TODO: trigger a notification in the client app somehow, to redraw UI etc?</li></ul></li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="when-a-server-update-transitions-an-experiment-to-cancelled-or-completed"></a>When a server update transitions an experiment to &quot;Cancelled&quot; or &quot;Completed&quot;<a class="hash-link" href="#when-a-server-update-transitions-an-experiment-to-cancelled-or-completed" title="Direct link to heading">#</a></h4><ul><li>If the current client state for the experiment is <strong>Enrolled</strong>:<ul><li>TODO: trigger a notification in the client app somehow, to redraw UI etc?</li><li>Set client state to <strong>WasEnrolled</strong>.</li></ul></li><li>Otherwise, discard the experiment state.</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="during-some-periodic-cleanup-process"></a>During some periodic cleanup process<a class="hash-link" href="#during-some-periodic-cleanup-process" title="Direct link to heading">#</a></h4><ul><li>For each experiment in the <strong>WasEnrolled</strong> state:<ul><li>If it has been more than N days since we entered that state, discard the experiment state.</li></ul></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="references"></a>References<a class="hash-link" href="#references" title="Direct link to heading">#</a></h2><ul><li><a href="https://docs.google.com/document/d/1RD-Ok9jYpa4cyyCAe-SO4xjITKN1ueh37WmN65u5BM4" target="_blank" rel="noopener noreferrer">Nimbus - Experiment Publishing Lifecycle and Permissions</a></li><li><a href="https://docs.google.com/document/d/18Vdn4zZX2D1u9AqzHRY0lUSUbpBdouqWtVp3Bu8vYQA/" target="_blank" rel="noopener noreferrer">Unpacking Unenrollments</a>, an explainer for data analysis needs around unenrolling/disabling experiments</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="changelog"></a>Changelog<a class="hash-link" href="#changelog" title="Direct link to heading">#</a></h2><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="2021-04-13-dmose"></a>2021-04-13 (dmose):<a class="hash-link" href="#2021-04-13-dmose" title="Direct link to heading">#</a></h4><ul><li>Moved from <a href="https://docs.google.com/document/d/18L3oNriwwLd5TZrM1SaHIfIJXmXqUkwNwQEPwVOTY6Q/edit#" target="_blank" rel="noopener noreferrer">Google Doc</a>, converted to MDX format, and commited to DocsHub.</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="2020-11-18-rfkelly"></a>2020-11-18 (rfkelly):<a class="hash-link" href="#2020-11-18-rfkelly" title="Direct link to heading">#</a></h4><ul><li>Renamed &quot;activation&quot; to &quot;exposure&quot; in line with terminology discussion from Nimbus Architecture Group meeting.</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="2020-11-13-rfkelly"></a>2020-11-13 (rfkelly):<a class="hash-link" href="#2020-11-13-rfkelly" title="Direct link to heading">#</a></h4><ul><li>Renamed &quot;disabled&quot;  state to &quot;disqualified&quot;</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="2020-11-11-rfkelly"></a>2020-11-11 (rfkelly):<a class="hash-link" href="#2020-11-11-rfkelly" title="Direct link to heading">#</a></h4><ul><li>Added the &quot;disabled&quot; state to client states.</li><li>Added the &quot;telemetry&quot; section.</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="2020-10-30-rfkelly"></a>2020-10-30 (rfkelly):<a class="hash-link" href="#2020-10-30-rfkelly" title="Direct link to heading">#</a></h4><ul><li>Added the key concept of &quot;disablement&quot; as distinct from unenrollment.</li><li>Simplified server states by:<ul><li>combining &quot;drafting + pending&quot; into &quot;preparing&quot;.<ul><li>also removed hypothetical logic around handling of &quot;startDate&quot; in order to start a pending experiment; it starts when visible in Remote Settings.</li></ul></li><li>combining &quot;completed  + cancelled&quot; into &quot;ended&quot;.</li><li>removed &quot;paused&quot; since it doesn&#x27;t sound like we have such a state that&#x27;s distinct from &quot;running&quot;.</li></ul></li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/mozilla/experimenter-docs/edit/main/docs/deep-dives/specifications/client-sdk-states-and-lifecycle.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/deep-dives/experimenter/rollouts"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Rollouts</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/fm-unimplemented-spec"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Proposed changes for Feature Manifest Language »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link">Introduction</a></li><li><a href="#key-concepts" class="table-of-contents__link">Key Concepts</a></li><li><a href="#server-side-experiment-states" class="table-of-contents__link">Server-Side Experiment States</a></li><li><a href="#client-side-experiment-states" class="table-of-contents__link">Client-Side Experiment States</a><ul><li><a href="#telemetry" class="table-of-contents__link">Telemetry</a></li></ul></li><li><a href="#client-behaviours" class="table-of-contents__link">Client Behaviours</a></li><li><a href="#references" class="table-of-contents__link">References</a></li><li><a href="#changelog" class="table-of-contents__link">Changelog</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Mozilla Corporation</div></div></div></footer></div>
<script src="/assets/js/runtime~main.90a1e22e.js"></script>
<script src="/assets/js/main.ae154802.js"></script>
</body>
</html>